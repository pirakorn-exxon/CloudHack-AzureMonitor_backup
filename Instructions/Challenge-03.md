# Challenge 03: Monitoring for Function App

[< Previous Challenge](./Challenge-02.md) - **[Home](../README.md)** - [Next Challenge >](./Challenge-04.md)

## Introduction

The third challenge is to create log search alert rules for monitoring function app.
![Challenge 05: Infrastructure](Images/Challenge-03-workflow.png 'Challenge 05: Infrastructure')

## Description

- **Step 1:** Enable diagnostic setting in function app to send function app logs and metrics to your log analytics workspace.
    - Navigate to your function app > Diagnostic settings > Add new diagnostic setting > Select `Function Application Logs` and `AllMetrics`.
<br>

- **Step 2:** Generate HTTP error response.
    - Navigate to your function app and execute a function name `GenerateErrorResponse` to generate HTTP error code `400` and `500`.
    - You can follow steps below to generate function error response:
        - Trigger `GenerateErrorResponse` function from the Function App created in Challenge 0: Pre-requisites
        - Go to `GenerateErrorResponse` function of your Function App
        - Go to `Code + Test` menu and wait for the logs screen at the bottom to say "Connected"
        ![GenerateErrorResponse Logs Screen](Images/TriggerGenerateErrorResponseLog.png 'GenerateErrorResponse Logs Screen')
        - Use `Test/Run` to trigger the function
        - This function requires one parameter
            - StatusCode: \<HTTP Status Code\> ([supported Status Code](https://learn.microsoft.com/en-us/dotnet/api/system.net.httpstatuscode?view=net-7.0))
        - This function will output with the status code you entered
        ![GenerateErrorResponse Test and Run](Images/TriggerGenerateErrorResponseRun.png 'GenerateErrorResponse Run')
<br>

- **Step 3:** Create a log search alert rule to detect the HTTP error in function app.
    - Navigate to your log analytics workspace > Create a custom query to detect HTTP error from `Http 4xx` and `Http Server Errors` metrics using `AzureMetrics` table > Create new alert rule based on this custom query.
        - Alert rule name: `<your name>-challenge3-1-alert`      
        - Required information: 
            - Severity = "Moderate"
            - Time of event
            - Description of the alert
    
    _- If the alert hasn't been triggered, please execute the function name `GenerateErrorResponse` again._
<br>

- **Step 4:** Create a log search alert rule to detect specific words in the message from function app.
    - Navigate to your log analytics workspace > create a custom query to detect keyword `Status Code: 400` and `Status Code: 500` that generated by function app name `GenerateErrorResponse` using `FunctionAppLogs` table > Create new alert rule based on this custom query.
        - Alert rule name: `<your name>-challenge3-2-alert` 
        - Required information: 
            - Severity = "Moderate"
            - Time of event
            - Description of the alert
    
    _- If the alert hasn't been triggered, please execute the function name `GenerateErrorResponse` again._
- **Step 5:** Ask coach to confirm that indidents are created in ServiceNow. 
    - ***Disable the alert rule the moment that you have seen the alert in ServiceNow to avoid too many tickets in the system.***
  
## Success Criteria

- Log search alert rule to monitor metrics data from function app.
- Log search alert rule to monitor specific words from function app logs.
- Alerts from log search alert rules in ServiceNow.

## Additional Resource

- [Monitoring Azure Functions](https://learn.microsoft.com/en-us/azure/azure-functions/monitor-functions?tabs=portal).
- [Supported metrics with Azure Monitor (Microsoft.Web/sites)](https://learn.microsoft.com/en-us/azure/azure-monitor/essentials/metrics-supported#microsoftwebsites).

[< Previous Challenge](./Challenge-02.md) - **[Home](../README.md)** - [Next Challenge >](./Challenge-04.md)
